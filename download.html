<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Äî –ú–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç</title>
  <style>
    :root {
      --primary: #4361ee;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --card-bg: white;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #f0f4f8;
      color: var(--dark);
      line-height: 1.6;
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding-top: 8px;
    }
    h1 {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subtitle {
      color: var(--gray);
      font-size: 0.95em;
      flex: 1 1 100%;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: 2px solid var(--primary);
      border-radius: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      min-height: 52px;
    }
    .btn.active {
      background: var(--primary);
      color: white;
    }
    .btn.inactive,
    .btn-outline {
      background: transparent;
      color: var(--primary);
    }
    .btn-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .hint {
      font-size: 0.85em;
      color: var(--gray);
      margin-top: 6px;
      display: block;
    }
    input[type="email"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 8px 0;
    }
    footer {
      text-align: center;
      color: var(--gray);
      font-size: 0.85em;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç—ã</h1>
      <div class="subtitle">–° –æ—Ç—á—ë—Ç–∞–º–∏ –ø–æ –∑–æ–Ω–∞–º —Ä–∏—Å–∫–∞ (–∫–æ–º—Ñ–æ—Ä—Ç/—Ä–∏—Å–∫/–∫—Ä–∏—Ç–∏—á–Ω–æ)</div>
    </div>
    <a href="help.html" class="btn btn-outline" style="padding:8px 12px; font-size:0.9em;">üìû –ü–æ–º–æ—â—å</a>
  </header>

  <div class="card">
    <h2>1. –ö–∞–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?</h2>
    <div class="btn-group" id="paramButtons">
      <button class="btn btn-outline" data-param="temp">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</button>
      <button class="btn btn-outline" data-param="hum">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</button>
      <button class="btn btn-outline" data-param="lux">‚òÄÔ∏è –û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å</button>
      <button class="btn btn-outline" data-param="all">üìä –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
    </div>
    <p id="paramHint" class="hint" style="margin-top:12px; display:none;">
      –í—ã–±—Ä–∞–Ω–æ: <span id="paramName">...</span>
    </p>
  </div>

  <div class="card">
    <h2>2. –ó–∞ –∫–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ?</h2>
    <div class="btn-group" id="periodButtons">
      <button class="btn btn-outline" data-period="day">üìÜ –ó–∞ —Å–µ–≥–æ–¥–Ω—è</button>
      <button class="btn btn-outline" data-period="week">üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é</button>
      <button class="btn btn-outline" data-period="month">üìÜ –ó–∞ –º–µ—Å—è—Ü</button>
      <button class="btn btn-outline" data-period="all">üóìÔ∏è –í—Å—ë –≤—Ä–µ–º—è</button>
    </div>
  </div>

  <div class="card">
    <h2>3. –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</h2>
    <button class="btn btn-primary" onclick="downloadCSV()" style="width:100%;">üìÑ –°–∫–∞—á–∞—Ç—å CSV</button>
  </div>

  <div class="card">
    <a href="index.html" class="btn btn-block btn-outline">‚óÄÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É</a>
  </div>

  <footer>
    –î–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É.
  </footer>

  <script>
    let selectedParam = null;
    let selectedPeriod = null;
    const paramNames = {
      temp: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞',
      hum: '–í–ª–∞–∂–Ω–æ—Å—Ç—å',
      lux: '–û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å',
      all: '–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã'
    };

    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤ –±—É–¥—É—â–µ–º ‚Äî –∏–∑ data.csv)
    const testData = [
      { timestamp: 1712300000, temp: 20.1, hum: 49, lux: 80 },
      { timestamp: 1712303600, temp: 20.3, hum: 48, lux: 85 },
      { timestamp: 1712310800, temp: 20.8, hum: 46, lux: 95 },
      { timestamp: 1712314400, temp: 21.0, hum: 45, lux: 100 },
      { timestamp: 1712318000, temp: 21.2, hum: 44, lux: 105 },
      { timestamp: 1712321600, temp: 21.5, hum: 43, lux: 110 },
      { timestamp: 1712325200, temp: 22.0, hum: 58, lux: 120 },
      { timestamp: 1712328800, temp: 22.3, hum: 48, lux: 120 },
      { timestamp: 1712332400, temp: 22.5, hum: 47, lux: 110 }
    ];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
    document.addEventListener('DOMContentLoaded', () => {
      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
      document.querySelectorAll('#paramButtons .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#paramButtons .btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedParam = btn.dataset.param;
          document.getElementById('paramName').textContent = paramNames[selectedParam];
          document.getElementById('paramHint').style.display = 'block';
        });
      });

      // –ü–µ—Ä–∏–æ–¥—ã
      document.querySelectorAll('#periodButtons .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#periodButtons .btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedPeriod = btn.dataset.period;
        });
      });
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
    function getPeriodStart(period) {
      const now = Math.floor(Date.now() / 1000);
      if (period === 'day') return now - 24 * 3600;
      if (period === 'week') return now - 7 * 24 * 3600;
      if (period === 'month') return now - 30 * 24 * 3600;
      return 0; // all
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV
    function downloadCSV() {
      if (!selectedParam || !selectedPeriod) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –∏ –ø–µ—Ä–∏–æ–¥.');
        return;
      }

      // –ü–æ–ª—É—á–∞–µ–º ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      const devices = JSON.parse(localStorage.getItem('devices') || '[]');
      const deviceId = devices.length > 0 ? devices[0].code : 'CLIM-DEMO';

      // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–µ—Ä–∏–æ–¥—É
      const periodStart = getPeriodStart(selectedPeriod);
      const filtered = testData.filter(d => d.timestamp >= periodStart);

      // –§–æ—Ä–º–∏—Ä—É–µ–º CSV
      let header, rows;
      if (selectedParam === 'all') {
        header = 'device_id,timestamp,temp,hum,lux';
        rows = filtered.map(d => `${deviceId},${d.timestamp},${d.temp},${d.hum},${d.lux}`);
      } else {
        header = `device_id,timestamp,${selectedParam}`;
        rows = filtered.map(d => `${deviceId},${d.timestamp},${d[selectedParam]}`);
      }

      const csvContent = [header, ...rows].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `climate_${selectedParam}_${selectedPeriod}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>