<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Äî –ú–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --card-bg: white;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #f0f4f8;
      color: var(--dark);
      line-height: 1.6;
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding-top: 8px;
    }
    h1 {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subtitle {
      color: var(--gray);
      font-size: 0.95em;
      flex: 1 1 100%;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: 2px solid var(--primary);
      border-radius: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      min-height: 52px;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .btn-outline {
      background: transparent;
      color: var(--primary);
    }
    .btn-success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
      border-color: var(--warning);
    }
    .btn-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .hint {
      font-size: 0.85em;
      color: var(--gray);
      margin-top: 6px;
      display: block;
    }
    .selection-info {
      background: #e7f3ff;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid var(--primary);
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--gray);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .stat-item {
      text-align: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .stat-value {
      font-size: 1.4em;
      font-weight: 700;
      color: var(--primary);
    }
    .stat-label {
      font-size: 0.8em;
      color: var(--gray);
    }
    footer {
      text-align: center;
      color: var(--gray);
      font-size: 0.85em;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .active {
      background: var(--primary) !important;
      color: white !important;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç—ã</h1>
      <div class="subtitle">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Å SD-–∫–∞—Ä—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
    </div>
    <div style="display: flex; gap: 10px;">
      <span id="userEmail" style="color: var(--gray); font-size: 0.9em;"></span>
      <button onclick="logout()" class="btn btn-outline" style="padding:8px 12px; font-size:0.9em;">üö™ –í—ã–π—Ç–∏</button>
    </div>
  </header>

  <div class="selection-info" id="selectionInfo" style="display: none;">
    <strong>–í—ã–±—Ä–∞–Ω–æ:</strong>
    <span id="selectedParamText">--</span> |
    <span id="selectedPeriodText">--</span> |
    –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: <strong id="currentDeviceText">--</strong>
  </div>

  <div class="card">
    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
    <div class="stats" id="dataStats">
      <div class="stat-item">
        <div class="stat-value" id="totalRecords">--</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="dataPeriod">--</div>
        <div class="stat-label">–ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="lastUpdate">--</div>
        <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>1. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä</h2>
    <div class="btn-group" id="paramButtons">
      <button class="btn btn-outline" data-param="temp">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</button>
      <button class="btn btn-outline" data-param="hum">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</button>
      <button class="btn btn-outline" data-param="lux">‚òÄÔ∏è –û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å</button>
      <button class="btn btn-outline" data-param="all">üìä –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
    </div>
  </div>

  <div class="card">
    <h2>2. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</h2>
    <div class="btn-group" id="periodButtons">
      <button class="btn btn-outline" data-period="day">üìÜ –°–µ–≥–æ–¥–Ω—è</button>
      <button class="btn btn-outline" data-period="week">üìÖ –ù–µ–¥–µ–ª—è</button>
      <button class="btn btn-outline" data-period="month">üóìÔ∏è –ú–µ—Å—è—Ü</button>
      <button class="btn btn-outline" data-period="all">‚è±Ô∏è –í—Å—ë –≤—Ä–µ–º—è</button>
    </div>
  </div>

   <div class="card">
    <h2>3. –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</h2>
    <p class="hint">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞ –∏ —è–∑—ã–∫ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</p>

    <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ -->
    <div style="margin: 15px 0;">
      <label style="font-weight: 600; display: block; margin-bottom: 8px;">üåç –Ø–∑—ã–∫ –æ—Ç—á–µ—Ç–∞:</label>
      <div style="display: flex; gap: 15px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="radio" name="language" value="ru" checked>
          <span>üá∑üá∫ –†—É—Å—Å–∫–∏–π</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="radio" name="language" value="en">
          <span>üá∫üá∏ English</span>
        </label>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" onclick="downloadCSV()" id="downloadBtn">
        üì• –°–∫–∞—á–∞—Ç—å CSV
      </button>
      <button class="btn btn-warning" onclick="downloadPDF()" id="downloadPdfBtn">
        üìÑ –°–∫–∞—á–∞—Ç—å PDF
      </button>
    </div>
    <div class="loading" id="loadingIndicator">
      ‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
      <div class="hint">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</div>
    </div>
    <div id="downloadResult" style="margin-top: 15px;"></div>
  </div>

  <div class="card">
    <div class="btn-group">
      <a href="index.html" class="btn btn-outline">üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</a>
      <a href="analytics.html" class="btn btn-outline">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
      <a href="dashboard.html" class="btn btn-outline">üè† –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
      <a href="settings.html" class="btn btn-outline">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
    </div>
  </div>

  <footer>
    –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –Ω–∞ SD-–∫–∞—Ä—Ç—É –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
  </footer>

  <script src="profile.js"></script>
  <script>
    let selectedParam = null;
    let selectedPeriod = null;
    let currentDeviceId = null;
    let allData = [];

    const paramNames = {
      temp: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
      hum: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)',
      lux: '–û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å (–ª–∫)',
      all: '–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã'
    };

    const periodNames = {
      day: '–ó–∞ —Å–µ–≥–æ–¥–Ω—è',
      week: '–ó–∞ –Ω–µ–¥–µ–ª—é',
      month: '–ó–∞ –º–µ—Å—è—Ü',
      all: '–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è'
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    async function initializePage() {
      if (!checkAuth()) return;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      document.getElementById('userEmail').textContent = getCurrentUserEmail();

      // –ü–æ–ª—É—á–∞–µ–º device_id –∏–∑ URL
      const urlParams = new URLSearchParams(window.location.search);
      currentDeviceId = urlParams.get('device');

      if (!currentDeviceId) {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const devices = await getUserDevices();
        if (devices && devices.length > 0) {
          currentDeviceId = devices[0].code;
          window.history.replaceState({}, '', `?device=${currentDeviceId}`);
        } else {
          alert('–£ –≤–∞—Å –Ω–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –î–æ–±–∞–≤—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.');
          window.location.href = 'dashboard.html';
          return;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
      const userDevices = await getUserDevices();
      const userDeviceCodes = userDevices.map(d => d.code);
      if (!userDeviceCodes.includes(currentDeviceId)) {
        alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É.');
        window.location.href = 'dashboard.html';
        return;
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      await loadDataAndUpdateStats();

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
      initializeButtons();

      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
      setInterval(loadDataAndUpdateStats, 2000);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadDataAndUpdateStats() {
      try {
        allData = await loadDeviceData(currentDeviceId);
        updateStatistics();
        updateSelectionInfo();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStatistics() {
      const statsElement = document.getElementById('dataStats');

      if (!allData || allData.length === 0) {
        document.getElementById('totalRecords').textContent = '0';
        document.getElementById('dataPeriod').textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        document.getElementById('lastUpdate').textContent = '--';
        return;
      }

      // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
      document.getElementById('totalRecords').textContent = allData.length;

      // –ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö
      const firstRecord = new Date(allData[0].timestamp * 1000);
      const lastRecord = new Date(allData[allData.length - 1].timestamp * 1000);
      const periodText = firstRecord.toLocaleDateString() + ' - ' + lastRecord.toLocaleDateString();
      document.getElementById('dataPeriod').textContent = periodText;

      // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      document.getElementById('lastUpdate').textContent = lastRecord.toLocaleTimeString();

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
      document.getElementById('currentDeviceText').textContent = currentDeviceId;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±–æ—Ä–µ
    function updateSelectionInfo() {
      const infoElement = document.getElementById('selectionInfo');

      if (selectedParam && selectedPeriod) {
        document.getElementById('selectedParamText').textContent = paramNames[selectedParam];
        document.getElementById('selectedPeriodText').textContent = periodNames[selectedPeriod];
        infoElement.style.display = 'block';
      } else {
        infoElement.style.display = 'none';
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞
    function initializeButtons() {
      // –ö–Ω–æ–ø–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      document.querySelectorAll('#paramButtons .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#paramButtons .btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedParam = btn.dataset.param;
          updateSelectionInfo();
        });
      });

      // –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–∏–æ–¥–æ–≤
      document.querySelectorAll('#periodButtons .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#periodButtons .btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedPeriod = btn.dataset.period;
          updateSelectionInfo();
        });
      });
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞
    function getPeriodTimeRange(period) {
      const now = Math.floor(Date.now() / 1000);
      const periods = {
        day: 24 * 3600,
        week: 7 * 24 * 3600,
        month: 30 * 24 * 3600,
        all: Infinity
      };
      return now - (periods[period] || 0);
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–µ—Ä–∏–æ–¥—É
    function filterDataByPeriod(data, period) {
      if (period === 'all') return data;

      const startTime = getPeriodTimeRange(period);
      return data.filter(item => item.timestamp >= startTime);
    }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV
    async function downloadCSV() {
      if (!selectedParam || !selectedPeriod) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –∏ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.');
        return;
      }

      if (!allData || allData.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.');
        return;
      }

      const downloadBtn = document.getElementById('downloadBtn');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const resultDiv = document.getElementById('downloadResult');

      // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫
      const language = document.querySelector('input[name="language"]:checked').value;

      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        downloadBtn.disabled = true;
        loadingIndicator.style.display = 'block';
        resultDiv.innerHTML = '';

        // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É
        const filteredData = filterDataByPeriod(allData, selectedPeriod);

        if (filteredData.length === 0) {
          alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.');
          return;
        }

        // –°–æ–∑–¥–∞–µ–º CSV —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞
        let csvContent = '';
        let filename = '';

        if (language === 'en') {
          // –ê–Ω–≥–ª–∏–π—Å–∫–∞—è –≤–µ—Ä—Å–∏—è CSV
          if (selectedParam === 'all') {
            // –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
            csvContent = "Time,Temperature (¬∞C),Humidity (%),Illuminance (lux)\n";
            filteredData.forEach(item => {
              const date = new Date(item.timestamp * 1000);
              const timeStr = date.toLocaleString('en-US');
              csvContent += `"${timeStr}",${item.temp.toFixed(1)},${item.hum.toFixed(1)},${Math.round(item.lux)}\n`;
            });
            filename = `climate_all_${currentDeviceId}_${selectedPeriod}.csv`;
          } else {
            // –û–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
            const paramHeader = {
              temp: "Time,Temperature (¬∞C)",
              hum: "Time,Humidity (%)",
              lux: "Time,Illuminance (lux)"
            }[selectedParam];

            csvContent = paramHeader + "\n";
            filteredData.forEach(item => {
              const date = new Date(item.timestamp * 1000);
              const timeStr = date.toLocaleString('en-US');
              const value = selectedParam === 'lux' ? Math.round(item[selectedParam]) : item[selectedParam].toFixed(1);
              csvContent += `"${timeStr}",${value}\n`;
            });
            filename = `climate_${selectedParam}_${currentDeviceId}_${selectedPeriod}.csv`;
          }
        } else {
          // –†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è CSV (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
          if (selectedParam === 'all') {
            csvContent = "–í—Ä–µ–º—è,–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C),–í–ª–∞–∂–Ω–æ—Å—Ç—å (%),–û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å (–ª–∫)\n";
            filteredData.forEach(item => {
              const date = new Date(item.timestamp * 1000);
              const timeStr = date.toLocaleString('ru-RU');
              csvContent += `"${timeStr}",${item.temp.toFixed(1)},${item.hum.toFixed(1)},${Math.round(item.lux)}\n`;
            });
            filename = `climate_all_${currentDeviceId}_${selectedPeriod}.csv`;
          } else {
            const paramHeader = {
              temp: "–í—Ä–µ–º—è,–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)",
              hum: "–í—Ä–µ–º—è,–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)",
              lux: "–í—Ä–µ–º—è,–û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å (–ª–∫)"
            }[selectedParam];

            csvContent = paramHeader + "\n";
            filteredData.forEach(item => {
              const date = new Date(item.timestamp * 1000);
              const timeStr = date.toLocaleString('ru-RU');
              const value = selectedParam === 'lux' ? Math.round(item[selectedParam]) : item[selectedParam].toFixed(1);
              csvContent += `"${timeStr}",${value}\n`;
            });
            filename = `climate_${selectedParam}_${currentDeviceId}_${selectedPeriod}.csv`;
          }
        }

        // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        const blob = new Blob(['\uFEFF' + csvContent], {
          type: 'text/csv;charset=utf-8;'
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        const languageText = language === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 'English';
        const successMessage = language === 'ru'
          ? `CSV –æ—Ç—á–µ—Ç —Å–∫–∞—á–∞–Ω: ${filteredData.length} –∑–∞–ø–∏—Å–µ–π`
          : `CSV report downloaded: ${filteredData.length} records`;

        resultDiv.innerHTML = `
          <div style="color: var(--success); font-weight: 600; padding: 10px; background: #e8f5e8; border-radius: 8px;">
            ‚úÖ ${language === 'ru' ? 'CSV –æ—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!' : 'CSV report successfully downloaded!'}
            <div style="font-size: 0.9em; margin-top: 5px;">
              ${language === 'ru' ? '–ü–∞—Ä–∞–º–µ—Ç—Ä' : 'Parameter'}: ${paramNames[selectedParam]} |
              ${language === 'ru' ? '–ü–µ—Ä–∏–æ–¥' : 'Period'}: ${periodNames[selectedPeriod]} |
              ${language === 'ru' ? '–Ø–∑—ã–∫' : 'Language'}: ${languageText}
            </div>
          </div>
        `;

        showNotification(successMessage, 'success');

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CSV:', error);
        resultDiv.innerHTML = `
          <div style="color: var(--danger); padding: 10px; background: #ffebee; border-radius: 8px;">
            ‚ùå ${language === 'ru' ? '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞:' : 'Error creating report:'} ${error.message}
          </div>
        `;
      } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        downloadBtn.disabled = false;
        loadingIndicator.style.display = 'none';
      }
    }


          // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ PDF –æ—Ç—á–µ—Ç–∞
    async function downloadPDF() {
      if (!selectedParam || !selectedPeriod) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –∏ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.');
        return;
      }

      if (!allData || allData.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.');
        return;
      }

      const downloadBtn = document.getElementById('downloadPdfBtn');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const resultDiv = document.getElementById('downloadResult');

      // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫
      const language = document.querySelector('input[name="language"]:checked').value;

      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        downloadBtn.disabled = true;
        loadingIndicator.style.display = 'block';
        resultDiv.innerHTML = '';

        // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É
        const filteredData = filterDataByPeriod(allData, selectedPeriod);

        if (filteredData.length === 0) {
          alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.');
          return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF –æ—Ç—á–µ—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏ —è–∑—ã–∫–æ–º
        const response = await fetch(`/api/device/${currentDeviceId}/report/generate-pdf`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            period: selectedPeriod,
            param: selectedParam,
            language: language  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫
          })
        });

        const data = await response.json();

        if (response.ok) {
          // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF
          const pdfBlob = base64ToBlob(data.pdf_data, 'application/pdf');
          const url = URL.createObjectURL(pdfBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = data.filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          const languageText = language === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 'English';
          resultDiv.innerHTML = `
            <div style="color: var(--success); font-weight: 600; padding: 10px; background: #e8f5e8; border-radius: 8px;">
              ‚úÖ PDF –æ—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!
              <div style="font-size: 0.9em; margin-top: 5px;">
                –ü–∞—Ä–∞–º–µ—Ç—Ä: ${paramNames[selectedParam]} | –ü–µ—Ä–∏–æ–¥: ${periodNames[selectedPeriod]} | –Ø–∑—ã–∫: ${languageText}
              </div>
            </div>
          `;

          const successMessage = language === 'ru'
            ? `PDF –æ—Ç—á–µ—Ç —Å–∫–∞—á–∞–Ω: ${filteredData.length} –∑–∞–ø–∏—Å–µ–π`
            : `PDF report downloaded: ${filteredData.length} records`;

          showNotification(successMessage, 'success');
        } else {
          resultDiv.innerHTML = `
            <div style="color: var(--danger); padding: 10px; background: #ffebee; border-radius: 8px;">
              ‚ùå –û—à–∏–±–∫–∞: ${data.error}
            </div>
          `;
        }

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF:', error);
        resultDiv.innerHTML = `
          <div style="color: var(--danger); padding: 10px; background: #ffebee; border-radius: 8px;">
            ‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
          </div>
        `;
      } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        downloadBtn.disabled = false;
        loadingIndicator.style.display = 'none';
      }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å base64
    function base64ToBlob(base64, contentType) {
      const byteCharacters = atob(base64);
      const byteArrays = [];

      for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }

      return new Blob(byteArrays, { type: contentType });
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', initializePage);




  </script>
</body>
</html>