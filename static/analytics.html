<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –ú–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --card-bg: white;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #f0f4f8;
      color: var(--dark);
      line-height: 1.6;
      padding: 16px;
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding-top: 8px;
    }
    h1 {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 6px;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      color: white;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); }
    .btn-warning { background: var(--warning); color: var(--dark); }
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .analytics-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      border-left: 4px solid var(--primary);
    }
    .analytics-card.trends { border-left-color: var(--success); }
    .analytics-card.correlations { border-left-color: var(--primary); }
    .analytics-card.anomalies { border-left-color: var(--warning); }
    .analytics-card.insights { border-left-color: var(--danger); }
    .stat-value {
      font-size: 2em;
      font-weight: 700;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 0.9em;
      color: var(--gray);
    }
    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      margin: 10px 0;
    }
    .trend-up { background: #ffebee; color: var(--danger); }
    .trend-down { background: #e8f5e8; color: var(--success); }
    .trend-stable { background: #fff8e1; color: #f57c00; }
    .correlation-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 8px 0;
      overflow: hidden;
    }
    .correlation-fill {
      height: 100%;
      border-radius: 4px;
    }
    .positive { background: var(--success); }
    .negative { background: var(--danger); }
    .anomaly-item {
      padding: 12px;
      margin: 8px 0;
      background: #fff8e1;
      border-radius: 8px;
      border-left: 3px solid var(--warning);
    }
    .insight-item {
      padding: 10px;
      margin: 6px 0;
      background: #e8f5e8;
      border-radius: 6px;
      font-size: 0.9em;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }
    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab-button {
      padding: 12px 20px;
      border: 2px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .tab-button.active {
      background: var(--primary);
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
      <div class="subtitle">AI-–∞–Ω–∞–ª–∏–∑ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–π, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π –∏ –∞–Ω–æ–º–∞–ª–∏–π</div>
    </div>
    <a href="help.html" class="btn btn-outline" style="padding:8px 12px; font-size:0.9em; width:auto;">üìû –ü–æ–º–æ—â—å</a>
  </header>

  <div class="card">
    <div class="tab-buttons">
      <button class="tab-button active" data-tab="summary">üìà –°–≤–æ–¥–∫–∞</button>
      <button class="tab-button" data-tab="trends">üìä –¢—Ä–µ–Ω–¥—ã</button>
      <button class="tab-button" data-tab="correlations">üîó –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏</button>
      <button class="tab-button" data-tab="anomalies">‚ö†Ô∏è –ê–Ω–æ–º–∞–ª–∏–∏</button>
      <button class="tab-button" data-tab="compare">üìÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
    </div>

    <!-- –°–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <div id="summary" class="tab-content active">
      <div class="analytics-grid">
        <div class="analytics-card trends">
          <h3>üìà –ü—Ä–æ–≥–Ω–æ–∑ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</h3>
          <div id="trendSummary" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="analytics-card correlations">
          <h3>üîó –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏</h3>
          <div id="correlationSummary" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="analytics-card anomalies">
          <h3>‚ö†Ô∏è –ê–Ω–æ–º–∞–ª–∏–∏</h3>
          <div id="anomalySummary" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="analytics-card insights">
          <h3>üí° –ò–Ω—Å–∞–π—Ç—ã</h3>
          <div id="insightsSummary" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>

      <div style="text-align: center; margin-top: 20px;">
        <button class="btn btn-primary" id="refreshAnalytics">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</button>
      </div>
    </div>

    <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã -->
    <div id="trends" class="tab-content">
      <h3>üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–π</h3>
      <div id="trendDetails" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ -->
    <div id="correlations" class="tab-content">
      <h3>üîó –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π</h3>
      <div id="correlationDetails" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –ê–Ω–æ–º–∞–ª–∏–∏ -->
    <div id="anomalies" class="tab-content">
      <h3>‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏</h3>
      <div id="anomalyDetails" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>



  <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ -->
    <div id="compare" class="tab-content">
      <h3>üìÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
        <div>
          <label style="font-weight: 600; display: block; margin-bottom: 8px;">–ü–µ—Ä–∏–æ–¥ 1:</label>
          <select id="comparePeriod1" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
            <option value="day">24 —á–∞—Å–∞</option>
            <option value="week" selected>–ù–µ–¥–µ–ª—è</option>
            <option value="month">–ú–µ—Å—è—Ü</option>
          </select>
        </div>
        <div>
          <label style="font-weight: 600; display: block; margin-bottom: 8px;">–ü–µ—Ä–∏–æ–¥ 2:</label>
          <select id="comparePeriod2" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
            <option value="week">–ù–µ–¥–µ–ª—è</option>
            <option value="month" selected>–ú–µ—Å—è—Ü</option>
            <option value="all">–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
          </select>
        </div>
      </div>

      <button class="btn btn-primary" onclick="comparePeriods()" id="compareBtn">
        üìä –°—Ä–∞–≤–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥—ã
      </button>

      <div id="compareResult" style="margin-top: 20px;"></div>
    </div>

   <a href="#" id="backToMonitor" class="btn btn-outline" style="display:block; text-align:center; margin-top:16px; width:auto; margin-left:auto; margin-right:auto;">
    ‚óÄÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É
  </a>



  <script src="profile.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const deviceId = urlParams.get('device');

    if (!deviceId) {
      const lastDeviceId = localStorage.getItem('lastDeviceId');
      if (lastDeviceId) {
        window.location.href = `analytics.html?device=${lastDeviceId}`;
      } else {
        alert('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ.');
        window.location.href = 'dashboard.html';
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É"
    document.getElementById('backToMonitor').href = `index.html?device=${deviceId}`;

    // –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
        button.classList.add('active');
        document.getElementById(button.dataset.tab).classList.add('active');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
        loadTabData(button.dataset.tab);
      });
    });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    async function loadTabData(tabName) {
      switch(tabName) {
        case 'summary':
          await loadSummaryAnalytics();
          break;
        case 'trends':
          await loadTrendDetails();
          break;
        case 'correlations':
          await loadCorrelationDetails();
          break;
        case 'anomalies':
          await loadAnomalyDetails();
          break;
        case 'compare':
          // –ñ–¥–µ–º –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          break;
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–¥–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    async function loadSummaryAnalytics() {
      try {
        const response = await fetch(`/api/device/${deviceId}/analytics/summary`);
        const data = await response.json();

        if (response.ok) {
          displaySummaryAnalytics(data);
        } else {
          document.getElementById('trendSummary').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
        document.getElementById('trendSummary').innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    function displaySummaryAnalytics(data) {
      // –¢—Ä–µ–Ω–¥—ã
      if (data.trends && !data.trends.error) {
        const trendsHtml = `
          <div class="stat-value">${data.trends.predicted_temp}¬∞C</div>
          <div class="trend-indicator ${getTrendClass(data.trends.trend)}">
            ${getTrendIcon(data.trends.trend)} ${data.trends.trend}
          </div>
          <div class="stat-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 6 —á–∞—Å–æ–≤</div>
          <div style="font-size: 0.8em; color: var(--gray);">
            –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${data.trends.confidence}
          </div>
        `;
        document.getElementById('trendSummary').innerHTML = trendsHtml;
      }

      // –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
      if (data.correlations && !data.correlations.error) {
        const mainCorrelation = data.correlations.correlations?.temp_hum;
        if (mainCorrelation) {
          const correlationHtml = `
            <div class="stat-value" style="color: ${getCorrelationColor(mainCorrelation.value)}">
              ${mainCorrelation.value}
            </div>
            <div class="correlation-bar">
              <div class="correlation-fill ${mainCorrelation.value > 0 ? 'positive' : 'negative'}"
                   style="width: ${Math.abs(mainCorrelation.value) * 100}%"></div>
            </div>
            <div class="stat-label">
              ${mainCorrelation.strength} —Å–≤—è–∑—å<br>
              ${mainCorrelation.interpretation}
            </div>
          `;
          document.getElementById('correlationSummary').innerHTML = correlationHtml;
        }
      }

      // –ê–Ω–æ–º–∞–ª–∏–∏
      if (data.anomalies && !data.anomalies.error) {
        const anomaliesHtml = `
          <div class="stat-value" style="color: ${data.anomalies.total_anomalies > 0 ? 'var(--warning)' : 'var(--success)'}">
            ${data.anomalies.total_anomalies}
          </div>
          <div class="stat-label">
            –∞–Ω–æ–º–∞–ª–∏–π –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ<br>
            ${data.anomalies.anomaly_rate}% –æ—Ç –¥–∞–Ω–Ω—ã—Ö
          </div>
          ${data.anomalies.summary ? `<div style="font-size: 0.8em; margin-top: 8px;">${data.anomalies.summary}</div>` : ''}
        `;
        document.getElementById('anomalySummary').innerHTML = anomaliesHtml;
      }

      // –ò–Ω—Å–∞–π—Ç—ã
      if (data.correlations && data.correlations.insights) {
        const insightsHtml = data.correlations.insights.map(insight =>
          `<div class="insight-item">${insight}</div>`
        ).join('');
        document.getElementById('insightsSummary').innerHTML = insightsHtml;
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Ç—Ä–µ–Ω–¥–æ–≤
    async function loadTrendDetails() {
      try {
        const response = await fetch(`/api/device/${deviceId}/analytics/trends`);
        const data = await response.json();

        if (response.ok && !data.error) {
          let html = `
            <div class="trend-indicator ${getTrendClass(data.trend)}" style="font-size: 1.2em; margin: 20px 0;">
              ${getTrendIcon(data.trend)} –¢—Ä–µ–Ω–¥: <strong>${data.trend}</strong>
            </div>
            <h4>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ 6 —á–∞—Å–æ–≤:</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
          `;

          data.next_hours.forEach(hour => {
            html += `
              <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 1.5em; font-weight: bold;">${hour.temp}¬∞C</div>
                <div style="font-size: 0.9em; color: var(--gray);">–ß–µ—Ä–µ–∑ ${hour.hour} —á</div>
              </div>
            `;
          });

          html += `</div>`;
          document.getElementById('trendDetails').innerHTML = html;
        } else {
          document.getElementById('trendDetails').innerHTML = '‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤');
        }
      } catch (error) {
        document.getElementById('trendDetails').innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π
    async function loadCorrelationDetails() {
      try {
        const response = await fetch(`/api/device/${deviceId}/analytics/correlations`);
        const data = await response.json();

        if (response.ok && !data.error) {
          let html = '<div style="display: grid; gap: 20px;">';

          Object.entries(data.correlations).forEach(([key, correlation]) => {
            const labels = {
              'temp_hum': 'üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ‚Üî üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å',
              'temp_lux': 'üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ‚Üî ‚òÄÔ∏è –û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å',
              'hum_lux': 'üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å ‚Üî ‚òÄÔ∏è –û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å'
            };

            html += `
              <div style="padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h4>${labels[key]}</h4>
                <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
                  <div style="font-size: 2em; font-weight: bold; color: ${getCorrelationColor(correlation.value)}">
                    ${correlation.value}
                  </div>
                  <div>
                    <div style="font-weight: 600;">${correlation.strength} —Å–≤—è–∑—å</div>
                    <div style="font-size: 0.9em; color: var(--gray);">${correlation.meaning}</div>
                  </div>
                </div>
                <div class="correlation-bar">
                  <div class="correlation-fill ${correlation.value > 0 ? 'positive' : 'negative'}"
                       style="width: ${Math.abs(correlation.value) * 100}%"></div>
                </div>
                ${correlation.interpretation ? `<div style="margin-top: 10px; font-style: italic;">${correlation.interpretation}</div>` : ''}
              </div>
            `;
          });

          html += '</div>';

          if (data.insights) {
            html += '<h4 style="margin-top: 30px;">üí° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã:</h4>';
            data.insights.forEach(insight => {
              html += `<div class="insight-item">${insight}</div>`;
            });
          }

          document.getElementById('correlationDetails').innerHTML = html;
        } else {
          document.getElementById('correlationDetails').innerHTML = '‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π');
        }
      } catch (error) {
        document.getElementById('correlationDetails').innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∞–Ω–æ–º–∞–ª–∏–π
    async function loadAnomalyDetails() {
      try {
        const response = await fetch(`/api/device/${deviceId}/analytics/anomalies`);
        const data = await response.json();

        if (response.ok && !data.error) {
          if (data.total_anomalies === 0) {
            document.getElementById('anomalyDetails').innerHTML = `
              <div style="text-align: center; padding: 40px; color: var(--success);">
                <div style="font-size: 3em;">‚úÖ</div>
                <h3>–ê–Ω–æ–º–∞–ª–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ!</h3>
                <p>–î–∞–Ω–Ω—ã–µ –≤—ã–≥–ª—è–¥—è—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º–∏</p>
              </div>
            `;
            return;
          }

          let html = `
            <div style="background: #fff8e1; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
              <strong>–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${data.total_anomalies} –∞–Ω–æ–º–∞–ª–∏–π (${data.anomaly_rate}% –¥–∞–Ω–Ω—ã—Ö)</strong>
              <br>${data.summary}
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
          `;

          data.anomalies.forEach(anomaly => {
            html += `
              <div class="anomaly-item">
                <div style="display: flex; justify-content: between; align-items: start;">
                  <div>
                    <strong>${anomaly.datetime}</strong>
                    <div style="font-size: 0.9em; color: var(--gray); margin: 5px 0;">
                      üå°Ô∏è ${anomaly.temp}¬∞C | üíß ${anomaly.hum}% | ‚òÄÔ∏è ${anomaly.lux} –ª–∫
                    </div>
                    <div style="font-size: 0.8em; background: #ffebee; padding: 4px 8px; border-radius: 4px; display: inline-block;">
                      ${anomaly.type}
                    </div>
                  </div>
                  <div style="font-size: 0.8em; color: var(--gray);">
                    score: ${anomaly.score}
                  </div>
                </div>
              </div>
            `;
          });

          html += '</div>';
          document.getElementById('anomalyDetails').innerHTML = html;
        } else {
          document.getElementById('anomalyDetails').innerHTML = '‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–æ–º–∞–ª–∏–π');
        }
      } catch (error) {
        document.getElementById('anomalyDetails').innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
      }
    }

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤
    async function comparePeriods() {
      const button = document.getElementById('compareBtn');
      const period1 = document.getElementById('comparePeriod1').value;
      const period2 = document.getElementById('comparePeriod2').value;

      button.innerHTML = '‚è≥ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ...';
      button.disabled = true;

      try {
        const response = await fetch(`/api/device/${deviceId}/report/compare`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ period1, period2 })
        });

        const data = await response.json();

        if (response.ok) {
          displayComparisonResult(data, period1, period2);
        } else {
          document.getElementById('compareResult').innerHTML = `
            <div style="color: var(--danger); padding: 15px; background: #ffebee; border-radius: 8px;">
              ‚ùå –û—à–∏–±–∫–∞: ${data.error}
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('compareResult').innerHTML = `
          <div style="color: var(--danger); padding: 15px; background: #ffebee; border-radius: 8px;">
            ‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
          </div>
        `;
      } finally {
        button.innerHTML = 'üìä –°—Ä–∞–≤–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥—ã';
        button.disabled = false;
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    function displayComparisonResult(data, period1, period2) {
      const changes = data.changes;
      const insights = data.insights || [];

      let html = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #e0e0e0;">
          <h4 style="margin-bottom: 20px; text-align: center;">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${period1} vs ${period2}</h4>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
              <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
              <div style="font-size: 1.8em; font-weight: bold; margin: 10px 0; color: ${getChangeColor(changes.temp_mean.trend)}">
                ${changes.temp_mean.absolute > 0 ? '+' : ''}${changes.temp_mean.absolute}¬∞C
              </div>
              <div class="change-indicator ${getChangeClass(changes.temp_mean.trend)}">
                ${getChangeIcon(changes.temp_mean.trend)} ${changes.temp_mean.percent}%
              </div>
            </div>

            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
              <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
              <div style="font-size: 1.8em; font-weight: bold; margin: 10px 0; color: ${getChangeColor(changes.hum_mean.trend)}">
                ${changes.hum_mean.absolute > 0 ? '+' : ''}${changes.hum_mean.absolute}%
              </div>
              <div class="change-indicator ${getChangeClass(changes.hum_mean.trend)}">
                ${getChangeIcon(changes.hum_mean.trend)} ${changes.hum_mean.percent}%
              </div>
            </div>

            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
              <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">‚òÄÔ∏è –û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å</div>
              <div style="font-size: 1.8em; font-weight: bold; margin: 10px 0; color: ${getChangeColor(changes.lux_mean.trend)}">
                ${changes.lux_mean.absolute > 0 ? '+' : ''}${changes.lux_mean.absolute} –ª–∫
              </div>
              <div class="change-indicator ${getChangeClass(changes.lux_mean.trend)}">
                ${getChangeIcon(changes.lux_mean.trend)} ${changes.lux_mean.percent}%
              </div>
            </div>
          </div>
      `;

      if (insights.length > 0) {
        html += `
          <div style="margin-top: 20px;">
            <h5 style="margin-bottom: 10px;">üí° –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:</h5>
            <ul style="margin: 0; padding-left: 20px;">
        `;
        insights.forEach(insight => {
          html += `<li style="margin-bottom: 8px;">${insight}</li>`;
        });
        html += `</ul></div>`;
      }

      html += `</div>`;
      document.getElementById('compareResult').innerHTML = html;
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    function getChangeClass(trend) {
      switch(trend) {
        case 'up': return 'change-up';
        case 'down': return 'change-down';
        default: return 'change-stable';
      }
    }

    function getChangeIcon(trend) {
      switch(trend) {
        case 'up': return 'üìà';
        case 'down': return 'üìâ';
        default: return '‚û°Ô∏è';
      }
    }

    function getChangeColor(trend) {
      switch(trend) {
        case 'up': return 'var(--danger)';
        case 'down': return 'var(--success)';
        default: return 'var(--gray)';
      }
    }


    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function getTrendClass(trend) {
      switch(trend) {
        case '—Ä–æ—Å—Ç': return 'trend-up';
        case '–ø–∞–¥–µ–Ω–∏–µ': return 'trend-down';
        default: return 'trend-stable';
      }
    }

    function getTrendIcon(trend) {
      switch(trend) {
        case '—Ä–æ—Å—Ç': return 'üìà';
        case '–ø–∞–¥–µ–Ω–∏–µ': return 'üìâ';
        default: return '‚û°Ô∏è';
      }
    }

    function getCorrelationColor(value) {
      const absValue = Math.abs(value);
      if (absValue < 0.3) return 'var(--gray)';
      if (absValue < 0.7) return 'var(--warning)';
      return value > 0 ? 'var(--success)' : 'var(--danger)';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    document.getElementById('refreshAnalytics').addEventListener('click', () => {
      loadTabData('summary');
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async () => {
      if (!isUserLoggedIn()) {
        window.location.href = 'login.html';
        return;
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
      await loadTabData('summary');
    })();
  </script>
</body>
</html>