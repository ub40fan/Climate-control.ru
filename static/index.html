<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ú–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --card-bg: white;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #f0f4f8;
      color: var(--dark);
      line-height: 1.6;
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding-top: 8px;
    }
    h1 {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    .metric {
      text-align: center;
      padding: 16px;
      border-top: 4px solid transparent;
      border-radius: 8px;
    }
    .metric--comfort { border-top-color: var(--success); background: #f0f9f4; }
    .metric--warning { border-top-color: var(--warning); background: #fff8e1; }
    .metric--danger  { border-top-color: var(--danger);  background: #ffebee; }
    .metric-value {
      font-size: 1.8em;
      font-weight: 700;
    }
    .metric-label {
      font-size: 0.9em;
      margin-top: 4px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: 2px solid var(--primary);
      border-radius: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      min-height: 52px;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-outline {
      background: transparent;
      color: var(--primary);
    }
    .btn-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    canvas {
      max-width: 100%;
      height: 240px !important;
      margin-top: 16px;
    }
    .legend {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      font-size: 0.85em;
      color: var(--gray);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
    .legend-comfort .legend-color { background: var(--success); }
    .legend-warning .legend-color { background: var(--warning); }
    .legend-danger .legend-color { background: var(--danger); }
    footer {
      text-align: center;
      color: var(--gray);
      font-size: 0.85em;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .status-info {
      text-align: center;
      padding: 10px;
      background: #e7f3ff;
      border-radius: 8px;
      margin: 10px 0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9em;
      color: var(--gray);
    }
    .device-selector {
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .device-selector select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üå°Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç–∞</h1>
      <div id="deviceInfo" class="status-info">
        –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: <strong id="currentDevice">--</strong> |
        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="lastUpdate">--</span>
      </div>
    </div>
    <div class="user-info">
      <span id="userEmail">--</span>
      <button onclick="logout()" class="btn btn-outline" style="padding:8px 12px; font-size:0.9em;">üö™ –í—ã–π—Ç–∏</button>
    </div>
  </header>

  <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
  <div class="card" id="deviceSelectorCard" style="display: none;">
    <h3>üì± –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h3>
    <div class="device-selector">
      <select id="deviceSelect">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ --</option>
      </select>
    </div>
  </div>

  <div class="card">
    <div class="metric-grid">
      <div class="metric metric--comfort" id="tempMetric">
        <div class="metric-value">--</div>
        <div class="metric-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
        <div>¬∞C</div>
      </div>
      <div class="metric metric--warning" id="humMetric">
        <div class="metric-value">--</div>
        <div class="metric-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
        <div>%</div>
      </div>
      <div class="metric metric--danger" id="luxMetric">
        <div class="metric-value">--</div>
        <div class="metric-label">–û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å</div>
        <div>–ª–∫</div>
      </div>
    </div>
    <p>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã</p>
    <div class="legend">
      <div class="legend-item legend-comfort">
        <div class="legend-color"></div>
        <span>–ö–æ–º—Ñ–æ—Ä—Ç</span>
      </div>
      <div class="legend-item legend-warning">
        <div class="legend-color"></div>
        <span>–†–∏—Å–∫</span>
      </div>
      <div class="legend-item legend-danger">
        <div class="legend-color"></div>
        <span>–ö—Ä–∏—Ç–∏—á–Ω–æ</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin-bottom:16px;">üìà –ü—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä–∞—Ñ–∏–∫–æ–≤</h2>

    <div class="btn-group" id="paramButtons">
      <button class="btn btn-primary" data-param="temp">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</button>
      <button class="btn btn-outline" data-param="hum">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</button>
      <button class="btn btn-outline" data-param="lux">‚òÄÔ∏è –û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å</button>
    </div>

    <div class="btn-group" id="periodButtons">
      <button class="btn btn-primary" data-period="day">–ó–∞ –¥–µ–Ω—å</button>
      <button class="btn btn-outline" data-period="week">–ó–∞ –Ω–µ–¥–µ–ª—é</button>
      <button class="btn btn-outline" data-period="month">–ó–∞ –º–µ—Å—è—Ü</button>
      <button class="btn btn-outline" data-period="all">–ó–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥</button>
    </div>

    <canvas id="climateChart"></canvas>
  </div>

  <div class="card">
    <h2 style="margin-bottom:16px;">üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
    <div class="btn-group">
     <a href="#" class="btn btn-outline" id="notificationsLink">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a>
      <a href="#" class="btn btn-outline" id="analyticsLink">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
    </div>
    <div class="btn-group">
      <a href="#" class="btn btn-primary" id="settingsLink">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å</a>
      <a href="#" class="btn btn-primary" id="downloadLink">üì• –û—Ç—á—ë—Ç—ã</a>

      <a href="dashboard.html" class="btn btn-primary">üè† –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>


    </div>

  </div>



  <script src="profile.js"></script>
  <script>
    let currentDeviceId = null;
    let currentParam = 'temp';
    let currentPeriod = 'day';
    let climateChart = null;
    let deviceSettings = null;
    let updateInterval = null;
    let userDevices = [];

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ —Å device_id
    function updateNavigationLinks() {
        if (currentDeviceId) {
            document.getElementById('settingsLink').href = `settings.html?device=${currentDeviceId}`;
            document.getElementById('downloadLink').href = `download.html?device=${currentDeviceId}`;
            document.getElementById('notificationsLink').href = `notifications.html?device=${currentDeviceId}`;
            document.getElementById('analyticsLink').href = `analytics.html?device=${currentDeviceId}`;


            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ localStorage
            localStorage.setItem('lastDeviceId', currentDeviceId);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    function initializeDeviceSelector(devices) {
        const deviceSelect = document.getElementById('deviceSelect');
        const deviceSelectorCard = document.getElementById('deviceSelectorCard');

        if (devices.length > 1) {
            deviceSelectorCard.style.display = 'block';

            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
            deviceSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ --</option>';
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.code;
                option.textContent = `${device.name} (${device.code})`;
                deviceSelect.appendChild(option);
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (currentDeviceId) {
                deviceSelect.value = currentDeviceId;
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            deviceSelect.addEventListener('change', function() {
                if (this.value) {
                    switchDevice(this.value);
                }
            });
        } else {
            deviceSelectorCard.style.display = 'none';
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    function switchDevice(newDeviceId) {
        if (currentDeviceId === newDeviceId) return;

        currentDeviceId = newDeviceId;

        // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const newUrl = `${window.location.pathname}?device=${currentDeviceId}`;
        window.history.replaceState({}, '', newUrl);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('currentDevice').textContent = currentDeviceId;
        updateNavigationLinks();

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –≥—Ä–∞—Ñ–∏–∫–∏
        reloadDeviceData();
    }

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    async function reloadDeviceData() {
        if (!currentDeviceId) return;

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
        if (updateInterval) {
            clearInterval(updateInterval);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ
        deviceSettings = await loadDeviceSettings(currentDeviceId);
        await updateDisplayData();
        await loadChart(currentPeriod);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        updateInterval = setInterval(updateDisplayData, 2000);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–ø–ª–µ–µ
    async function updateDisplayData() {
        if (!currentDeviceId) return;

        try {
            const data = await loadDeviceData(currentDeviceId);

            if (data.length === 0) {
                document.getElementById('tempMetric').querySelector('.metric-value').textContent = '--';
                document.getElementById('humMetric').querySelector('.metric-value').textContent = '--';
                document.getElementById('luxMetric').querySelector('.metric-value').textContent = '--';
                return;
            }

            const latestData = data[data.length - 1];

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            document.getElementById('tempMetric').querySelector('.metric-value').textContent = latestData.temp.toFixed(1);
            document.getElementById('humMetric').querySelector('.metric-value').textContent = latestData.hum.toFixed(1);
            document.getElementById('luxMetric').querySelector('.metric-value').textContent = Math.round(latestData.lux);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–æ–Ω—ã –∫–æ–º—Ñ–æ—Ä—Ç–∞
            updateMetricClass(document.getElementById('tempMetric'), getZoneForValue(latestData.temp, 'temp', deviceSettings));
            updateMetricClass(document.getElementById('humMetric'), getZoneForValue(latestData.hum, 'hum', deviceSettings));
            updateMetricClass(document.getElementById('luxMetric'), getZoneForValue(latestData.lux, 'lux', deviceSettings));

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (climateChart) {
                loadChart(currentPeriod);
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
    async function loadChart(period) {
        if (!currentDeviceId) return;

        const allData = await loadDeviceData(currentDeviceId);
        if (allData.length === 0) return;

        const now = Math.floor(Date.now() / 1000);
        let filtered = allData;

        if (period === 'day') filtered = allData.filter(d => d.timestamp > now - 24*3600);
        else if (period === 'week') filtered = allData.filter(d => d.timestamp > now - 7*24*3600);
        else if (period === 'month') filtered = allData.filter(d => d.timestamp > now - 30*24*3600);

        if (filtered.length === 0) return;

        const labels = filtered.map(d => {
            const date = new Date(d.timestamp * 1000);
            return period === 'day'
                ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : date.toLocaleDateString();
        });

        const values = filtered.map(d => d[currentParam]);

        // –°–æ–∑–¥–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
        const segments = [];
        let currentSegment = { data: [], labels: [], borderColor: '#4361ee' };

        for (let i = 0; i < values.length; i++) {
            const zone = getZoneForValue(values[i], currentParam, deviceSettings);
            let color;

            switch(zone) {
                case 'comfort': color = '#06d6a0'; break;
                case 'warning': color = '#ffd166'; break;
                case 'danger': color = '#ef476f'; break;
                default: color = '#4361ee';
            }

            if (currentSegment.borderColor !== color) {
                if (currentSegment.data.length > 0) {
                    segments.push(currentSegment);
                }
                currentSegment = {
                    data: [],
                    labels: [],
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                };
            }

            currentSegment.data.push(values[i]);
            currentSegment.labels.push(labels[i]);
        }

        if (currentSegment.data.length > 0) {
            segments.push(currentSegment);
        }

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫
        const ctx = document.getElementById('climateChart').getContext('2d');
        if (climateChart) climateChart.destroy();

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
        climateChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: segments.map(segment => ({
                    label: currentParam,
                    data: segment.data,
                    borderColor: segment.borderColor,
                    backgroundColor: segment.backgroundColor,
                    borderWidth: segment.borderWidth,
                    tension: segment.tension,
                    fill: segment.fill,
                    pointRadius: 0
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { display: false }
                    },
                    y: {
                        display: true,
                        beginAtZero: currentParam === 'lux'
                    }
                }
            }
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    async function initializePage() {
        if (!checkAuth()) return;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('userEmail').textContent = getCurrentUserEmail();

        // –ü–æ–ª—É—á–∞–µ–º device_id –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        currentDeviceId = urlParams.get('device');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        userDevices = await getUserDevices();

        if (userDevices.length === 0) {
            alert('–£ –≤–∞—Å –Ω–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –î–æ–±–∞–≤—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.');
            window.location.href = 'dashboard.html';
            return;
        }

        // –ï—Å–ª–∏ device –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL, –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        if (!currentDeviceId) {
            // 1. –ü—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ localStorage
            currentDeviceId = localStorage.getItem('lastDeviceId');

            // 2. –ï—Å–ª–∏ –Ω–µ—Ç –≤ localStorage, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            if (!currentDeviceId && userDevices.length > 0) {
                currentDeviceId = userDevices[0].code;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º URL —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
            if (currentDeviceId) {
                const newUrl = `${window.location.pathname}?device=${currentDeviceId}`;
                window.history.replaceState({}, '', newUrl);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        const userDeviceCodes = userDevices.map(d => d.code);
        if (!userDeviceCodes.includes(currentDeviceId)) {
            // –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ
            currentDeviceId = userDevices[0].code;
            const newUrl = `${window.location.pathname}?device=${currentDeviceId}`;
            window.history.replaceState({}, '', newUrl);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        initializeDeviceSelector(userDevices);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        document.getElementById('currentDevice').textContent = currentDeviceId;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
        updateNavigationLinks();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ
        deviceSettings = await loadDeviceSettings(currentDeviceId);
        await updateDisplayData();
        await loadChart(currentPeriod);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        updateInterval = setInterval(updateDisplayData, 2000);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        document.querySelectorAll('#paramButtons .btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#paramButtons .btn').forEach(b =>
                    b.classList.replace('btn-primary', 'btn-outline'));
                btn.classList.replace('btn-outline', 'btn-primary');
                currentParam = btn.dataset.param;
                loadChart(currentPeriod);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞
        document.querySelectorAll('#periodButtons .btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#periodButtons .btn').forEach(b =>
                    b.classList.replace('btn-primary', 'btn-outline'));
                btn.classList.replace('btn-outline', 'btn-primary');
                currentPeriod = btn.dataset.period;
                loadChart(currentPeriod);
            });
        });
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', initializePage);

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
        if (updateInterval) clearInterval(updateInterval);
    });
  </script>
</body>
</html>